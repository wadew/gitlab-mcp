# GitLab CI/CD Pipeline for GitLab MCP Server
# Branch Strategy:
# - develop/MRs: Full quality checks (lint, test, security, SonarQube)
# - main: Version bump, build, and publish to GitLab Package Registry

# ============================================================================
# WORKFLOW RULES - Prevent duplicate pipelines
# ============================================================================
workflow:
  name: 'Pipeline: $CI_COMMIT_BRANCH$CI_MERGE_REQUEST_IID'
  rules:
    # Run for merge request events
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # Run for tags (releases)
    - if: $CI_COMMIT_TAG
    # Run for main branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    # Run for develop branch
    - if: $CI_COMMIT_BRANCH == "develop"
    # Run for feature branches (but not if MR is open to prevent duplicates)
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
    - if: $CI_COMMIT_BRANCH

# ============================================================================
# GLOBAL VARIABLES
# ============================================================================
variables:
  # Python settings
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  UV_CACHE_DIR: "$CI_PROJECT_DIR/.cache/uv"

  # Coverage settings
  COVERAGE_THRESHOLD: "80"

  # Test settings
  PYTEST_ADDOPTS: "--color=yes"

  # Security scanning
  SAST_EXCLUDED_PATHS: "tests,docs,.venv"
  CONTAINER_SCANNING_DISABLED: "true"  # No Docker containers in this project

  # Cache configuration
  CACHE_FALLBACK_KEY: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"

  # SonarQube settings
  SONAR_PROJECT_KEY: "gitlab-mcp-server"
  SONAR_HOST_URL: "https://sonarqube.prod.thezephyrco.com"

  # Package settings
  PACKAGE_REGISTRY_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi"

# ============================================================================
# STAGES - Ordered pipeline execution
# ============================================================================
stages:
  - lint      # Code quality and formatting checks (develop/MRs only)
  - test      # Run tests with coverage (develop/MRs only)
  - security  # Security scanning (develop/MRs only)
  - quality   # SonarQube analysis (develop/MRs only)
  - version   # Version bump (main only)
  - build     # Package build (main only)
  - publish   # Publish to GitLab Package Registry (main only)

# ============================================================================
# REUSABLE TEMPLATES
# ============================================================================

# Base template for Python jobs
.python-base:
  image: python:3.11  # Default Python version
  before_script:
    # Install uv for fast dependency management
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv --version
  cache:
    # Cache Python dependencies for faster builds
    - key:
        files:
          - pyproject.toml
      paths:
        - .cache/uv
        - .cache/pip
        - .venv/
      policy: pull-push
    # Fallback cache
    - key: "$CACHE_FALLBACK_KEY"
      paths:
        - .cache/uv
        - .cache/pip
      policy: pull

# Template for uv venv setup
.uv-install:
  extends: .python-base
  before_script:
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv venv
    - source .venv/bin/activate
    - uv pip install -e ".[dev]"

# Template for jobs that only run on develop/MRs (not main)
.develop-only:
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - when: never

# Template for jobs that only run on main branch
.main-only:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - when: never

# ============================================================================
# LINT STAGE - Code quality and formatting (develop/MRs only)
# ============================================================================

lint:ruff:
  extends:
    - .uv-install
    - .develop-only
  stage: lint
  script:
    - echo "Running ruff linter..."
    - ruff check src/gitlab_mcp/ tests/ --output-format=gitlab > ruff-report.json || true
    - ruff check src/gitlab_mcp/ tests/
  artifacts:
    reports:
      codequality: ruff-report.json
    expire_in: 1 week
    when: always
  allow_failure: false

lint:black:
  extends:
    - .uv-install
    - .develop-only
  stage: lint
  script:
    - echo "Checking code formatting with black..."
    - black --check --diff src/gitlab_mcp/ tests/
  allow_failure: false

lint:mypy:
  extends:
    - .uv-install
    - .develop-only
  stage: lint
  script:
    - echo "Running mypy type checker..."
    - mypy src/gitlab_mcp/ --junit-xml=mypy-report.xml --exclude='.venv'
  artifacts:
    reports:
      junit: mypy-report.xml
    expire_in: 1 week
    when: always
  allow_failure: false

# ============================================================================
# TEST STAGE - Run tests with coverage (develop/MRs only)
# ============================================================================

# Unit tests matrix - run across multiple Python versions
.test-unit-template:
  extends:
    - .uv-install
    - .develop-only
  stage: test
  needs: []  # Start immediately (don't wait for lint)
  script:
    - echo "Running unit tests on Python $PYTHON_VERSION..."
    - pytest tests/unit/ -v --tb=short --junitxml=junit-unit.xml
  artifacts:
    reports:
      junit: junit-unit.xml
    expire_in: 1 week
    when: always
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'

# Python 3.10 unit tests
test:unit:py310:
  extends: .test-unit-template
  image: python:3.10
  variables:
    PYTHON_VERSION: "3.10"

# Python 3.11 unit tests (with coverage)
test:unit:py311:
  extends: .test-unit-template
  image: python:3.11
  variables:
    PYTHON_VERSION: "3.11"
  script:
    - echo "Running unit tests with coverage on Python $PYTHON_VERSION..."
    - pytest tests/unit/ tests/e2e/ -v --tb=short --cov=src/gitlab_mcp --cov-report=xml --cov-report=term --cov-report=html --junitxml=junit-unit.xml
    - echo "Checking coverage threshold (>= ${COVERAGE_THRESHOLD}%)..."
    - coverage report --fail-under=${COVERAGE_THRESHOLD}
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    reports:
      junit: junit-unit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
      - coverage.xml
      - junit-unit.xml
    expire_in: 1 week
    when: always

# Python 3.12 unit tests
test:unit:py312:
  extends: .test-unit-template
  image: python:3.12
  variables:
    PYTHON_VERSION: "3.12"

# E2E MCP integration tests (single Python version)
test:e2e:
  extends:
    - .uv-install
    - .develop-only
  stage: test
  needs: []  # Start immediately
  image: python:3.11
  script:
    - echo "Running E2E MCP integration tests..."
    - pytest tests/e2e/ -v --tb=short --junitxml=junit-e2e.xml -m e2e
  artifacts:
    reports:
      junit: junit-e2e.xml
    expire_in: 1 week
    when: always

# Integration tests with real GitLab API
test:integration:
  extends: .uv-install
  stage: test
  needs: []  # Start immediately
  image: python:3.11
  script:
    - echo "Running integration tests with real GitLab API..."
    - pytest tests/integration/ -v --tb=short --junitxml=junit-integration.xml -m integration
  artifacts:
    reports:
      junit: junit-integration.xml
    expire_in: 1 week
    when: always
  rules:
    # Run on develop branch
    - if: $CI_COMMIT_BRANCH == "develop"
    # Run on merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # Skip for other branches
    - when: never
  # Allow failure since these tests require external GitLab API access
  allow_failure: true

# ============================================================================
# SECURITY STAGE - Security scanning (develop/MRs only)
# ============================================================================

# Include GitLab's built-in security scanning templates
# Note: These templates have complex rules that shouldn't be overridden.
# They run on all branches by default, which is fine - security scanning on main
# is lightweight and provides an extra safety check before publishing.
include:
  - template: Jobs/SAST.gitlab-ci.yml
  - template: Jobs/Dependency-Scanning.gitlab-ci.yml
  - template: Jobs/Secret-Detection.gitlab-ci.yml

# Additional: pip-audit for Python-specific security scanning
security:pip-audit:
  extends: .uv-install
  stage: security
  needs: []
  script:
    - echo "Running pip-audit for Python dependency security scanning..."
    - uv pip install pip-audit
    - pip-audit --desc --format json --output pip-audit-report.json || true
    - pip-audit --desc || true
  artifacts:
    paths:
      - pip-audit-report.json
    expire_in: 1 week
    when: always
  allow_failure: true  # Don't block pipeline on vulnerabilities
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - when: never

# ============================================================================
# QUALITY STAGE - SonarQube Analysis (develop/MRs only)
# ============================================================================

quality:sonarqube:
  stage: quality
  image: sonarsource/sonar-scanner-cli:latest
  needs:
    - job: test:unit:py311
      artifacts: true
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"  # Full git history for accurate blame information
  script:
    - echo "Running SonarQube analysis..."
    - |
      sonar-scanner \
        -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
        -Dsonar.host.url=${SONAR_HOST_URL} \
        -Dsonar.token=${SONAR_TOKEN} \
        -Dsonar.sources=src/gitlab_mcp \
        -Dsonar.tests=tests \
        -Dsonar.python.version=3.10,3.11,3.12 \
        -Dsonar.python.coverage.reportPaths=coverage.xml \
        -Dsonar.python.xunit.reportPaths=junit-unit.xml \
        -Dsonar.exclusions=**/__pycache__/**,**/htmlcov/**,.venv/** \
        -Dsonar.test.exclusions=tests/** \
        -Dsonar.qualitygate.wait=true
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  rules:
    # Run on develop branch
    - if: $CI_COMMIT_BRANCH == "develop"
    # Run on merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # Skip for other branches
    - when: never
  allow_failure: false

# ============================================================================
# VERSION STAGE - CalVer version bump (main only)
# ============================================================================

version:bump:
  extends: .main-only
  stage: version
  image: python:3.11
  before_script:
    - apt-get update && apt-get install -y git
    - git config user.email "ci@gitlab.prod.thezephyrco.com"
    - git config user.name "GitLab CI"
  script:
    - echo "Calculating CalVer version..."
    - |
      # Get current date components
      YEAR=$(date +%Y)
      MONTH=$(date +%-m)  # No leading zero

      # Get current version from pyproject.toml
      CURRENT_VERSION=$(grep -Po '(?<=^version = ")[^"]+' pyproject.toml)
      echo "Current version: ${CURRENT_VERSION}"

      # Parse current version to check if it's from this month
      CURRENT_YEAR=$(echo $CURRENT_VERSION | cut -d. -f1)
      CURRENT_MONTH=$(echo $CURRENT_VERSION | cut -d. -f2)
      CURRENT_MICRO=$(echo $CURRENT_VERSION | cut -d. -f3)

      # Calculate new version
      if [ "$CURRENT_YEAR" = "$YEAR" ] && [ "$CURRENT_MONTH" = "$MONTH" ]; then
        # Same month, increment micro
        NEW_MICRO=$((CURRENT_MICRO + 1))
      else
        # New month, reset micro to 0
        NEW_MICRO=0
      fi

      NEW_VERSION="${YEAR}.${MONTH}.${NEW_MICRO}"
      echo "New version: ${NEW_VERSION}"

      # Update pyproject.toml
      sed -i "s/^version = \"${CURRENT_VERSION}\"/version = \"${NEW_VERSION}\"/" pyproject.toml

      # Verify the change
      grep "^version" pyproject.toml

      # Export for next jobs
      echo "NEW_VERSION=${NEW_VERSION}" >> version.env
      echo "PREVIOUS_VERSION=${CURRENT_VERSION}" >> version.env
    - cat version.env
  artifacts:
    paths:
      - pyproject.toml
    reports:
      dotenv: version.env
    expire_in: 1 day

# ============================================================================
# BUILD STAGE - Package Build (main only)
# ============================================================================

build:package:
  extends: .main-only
  stage: build
  image: python:3.11
  needs:
    - job: version:bump
      artifacts: true
  before_script:
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv venv
    - source .venv/bin/activate
    - uv pip install build twine
  script:
    - echo "Building Python package version ${NEW_VERSION}..."
    - python -m build
    - echo "Verifying package..."
    - twine check dist/*
    - ls -la dist/
  artifacts:
    paths:
      - dist/
      - pyproject.toml
    expire_in: 1 week

# ============================================================================
# PUBLISH STAGE - GitLab Package Registry (main only)
# ============================================================================

publish:pypi:
  extends: .main-only
  stage: publish
  image: python:3.11
  needs:
    - job: build:package
      artifacts: true
    - job: version:bump
      artifacts: true
  before_script:
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"
    - uv venv
    - source .venv/bin/activate
    - uv pip install twine
  script:
    - echo "Publishing package version ${NEW_VERSION} to GitLab Package Registry..."
    - |
      TWINE_PASSWORD=${CI_JOB_TOKEN} \
      TWINE_USERNAME=gitlab-ci-token \
      python -m twine upload \
        --repository-url ${PACKAGE_REGISTRY_URL} \
        dist/*
    - echo "Package ${NEW_VERSION} published successfully!"
    - echo "Previous version was ${PREVIOUS_VERSION}"

# Commit the version bump back to the repository
publish:version-commit:
  extends: .main-only
  stage: publish
  image: alpine:latest
  needs:
    - job: publish:pypi
      artifacts: false
    - job: version:bump
      artifacts: true
  before_script:
    - apk add --no-cache git curl
  script:
    - echo "Committing version bump ${NEW_VERSION} back to repository..."
    - |
      # Clone with write access using CI job token
      git clone --branch main "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" repo
      cd repo

      # Configure git identity inside the cloned repo
      git config user.email "ci@gitlab.prod.thezephyrco.com"
      git config user.name "GitLab CI"

      # Copy the updated pyproject.toml
      cp ../pyproject.toml .

      # Check if there are changes
      if git diff --quiet pyproject.toml; then
        echo "No version changes to commit"
        exit 0
      fi

      # Commit and push
      git add pyproject.toml
      git commit -m "chore(release): bump version to ${NEW_VERSION} [skip ci]"
      git push origin main

      echo "Version ${NEW_VERSION} committed to main branch"
  allow_failure: true  # Don't fail pipeline if commit fails

# ============================================================================
# PUBLIC PYPI PUBLISHING (Tag-based releases)
# ============================================================================

# Publish to PyPI on semantic version tags (v1.0.0, v1.2.3, etc.)
publish:public-pypi:
  stage: publish
  image: python:3.12-slim
  before_script:
    - pip install build twine
  script:
    - echo "Publishing to PyPI..."
    - python -m build
    - twine check dist/*
    - twine upload dist/* --username __token__ --password $PYPI_TOKEN
    - echo "Published ${CI_COMMIT_TAG} to PyPI successfully!"
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/

# Publish to TestPyPI on release candidate tags (v1.0.0-rc1, etc.)
publish:testpypi:
  stage: publish
  image: python:3.12-slim
  before_script:
    - pip install build twine
  script:
    - echo "Publishing to TestPyPI..."
    - python -m build
    - twine check dist/*
    - twine upload --repository testpypi dist/* --username __token__ --password $TESTPYPI_TOKEN
    - echo "Published ${CI_COMMIT_TAG} to TestPyPI successfully!"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+-rc/

# Mirror to public GitHub repository on version tags
publish:github-mirror:
  stage: publish
  image: alpine:latest
  before_script:
    - apk add --no-cache git
  script:
    - echo "Mirroring to GitHub..."
    - git remote add github https://${GITHUB_COM_TOKEN}@github.com/wadew/gitlab-mcp.git || true
    - git push github HEAD:refs/heads/main --tags --force
    - echo "Mirrored ${CI_COMMIT_TAG} to GitHub successfully!"
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: "0"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+/

# ============================================================================
# PIPELINE DOCUMENTATION
# ============================================================================
#
# Branch Strategy:
# ================
# - develop: Full quality pipeline
#   - Lint: ruff, black, mypy
#   - Test: Unit tests (Python 3.10-3.12), E2E, Integration
#   - Security: SAST, dependency scanning, secret detection, pip-audit
#   - Quality: SonarQube analysis with quality gate
#
# - main: Release pipeline (MR from develop only)
#   - Version: Auto CalVer bump (YYYY.MM.MICRO)
#   - Build: Create sdist and wheel packages
#   - Publish: Upload to GitLab Package Registry
#   - Commit: Push version bump back to main
#
# - Tags (vX.Y.Z): Public release pipeline
#   - publish:public-pypi: Upload to pypi.org
#   - publish:github-mirror: Mirror to github.com/wadew/gitlab-mcp
#
# - Tags (vX.Y.Z-rc*): Release candidate pipeline
#   - publish:testpypi: Upload to test.pypi.org
#
# - MRs: Same as develop (quality checks before merge)
#
# Required CI/CD Variables:
# =========================
# - PYPI_TOKEN: API token from pypi.org
# - TESTPYPI_TOKEN: API token from test.pypi.org
# - GITHUB_COM_TOKEN: GitHub PAT for repository mirroring
# - SONAR_TOKEN: SonarQube authentication token
#
# ============================================================================
